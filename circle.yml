general:
  branches:
    ignore:
      - gh-pages

machine:
  services:
    - docker
  environment:
    GOPATH: /home/ubuntu
    SRCDIR: /home/ubuntu/src/github.com/weaveworks/service
    PATH: /usr/local/go/bin:$HOME/bin:$PATH

dependencies:
  cache_directories:
    - "~/docker"
  post:
    - mkdir -p $(dirname $SRCDIR)
    - cp -r $(pwd)/ $SRCDIR
    - go get -u github.com/weaveworks/build-tools/cmd/wcloud
    - |
        cd $SRCDIR/build && \
        ../tools/rebuild-image quay.io/weaveworks/build . build.sh Dockerfile && \
        touch .uptodate

test:
  override:
    - |
        cd $SRCDIR; if [ $(./tools/image-tag --show-diff | grep -e '-WIP$') ]; then
           echo "WIP build; exiting with error to mark as a failure"
           exit 1
        fi
    - cd $SRCDIR; make RM= lint
    - cd $SRCDIR; COVERDIR=./coverage make RM= test
    - cd $SRCDIR; make RM=
    - cd $SRCDIR; make RM= configs-integration-test
    - cd $SRCDIR; make RM= users-integration-test
    - cd $SRCDIR; make RM= client-lint

teardown:
  pre:
    - cd $SRCDIR; ./tools/cover/gather_coverage.sh ./coverage $SRCDIR/coverage
    - go get github.com/mattn/goveralls
    - goveralls -repotoken $COVERALLS_REPO_TOKEN -coverprofile=$SRCDIR/profile.cov -service=circleci || true
    - cd $SRCDIR; cp coverage.* $CIRCLE_ARTIFACTS

deployment:
  push:
    branch: master
    commands:
      - docker login -e '.' -u "$DOCKER_REGISTRY_USER" -p "$DOCKER_REGISTRY_PASSWORD" quay.io
      - |
          set -o pipefail
          export LAST_BUILD_COMMIT=$(curl -sS 'https://circleci.com/api/v1/project/weaveworks/service/tree/'$CIRCLE_BRANCH'?circle-token='$CIRCLE_TOKEN'&filter=successful&limit=1' | jq -r '.[0].vcs_revision')
          echo Last successful build was commit $LAST_BUILD_COMMIT
          ./push-images --and-deploy --if-changed-since $LAST_BUILD_COMMIT
