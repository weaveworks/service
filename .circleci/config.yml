version: 2
defaults: &defaults
  machine:
    docker_layer_caching: true
  working_directory: ~/weaveworks/service
jobs:
  lint:
    <<: *defaults
    steps:
      - checkout
      - run: make RM= lint

  build:
    <<: *defaults
    steps:
      - checkout
      - run: sudo docker info >/dev/null 2>&1 || sudo service docker start;
      # FIXME: we probably don't need to copy the code and change the working dir
      - run: echo -e "export GOPATH=$HOME\nexport SRCDIR=$HOME/src/github.com/weaveworks/service\nexport PATH=/usr/local/go/bin:$HOME/bin:$PATH" >> $BASH_ENV
      - run: mkdir -p $(dirname $SRCDIR) && cp -r $(pwd)/ $SRCDIR
      - run: |
          cd $SRCDIR/build
          ../tools/rebuild-image quay.io/weaveworks/build . build.sh Dockerfile
          touch .uptodate
      - run: cd $SRCDIR; make RM=
      - run: |
          set -e
          set -o pipefail
          cd $SRCDIR; if [ $(./tools/image-tag | grep -e '-WIP$') ]; then
            echo "WIP build; exiting with error to mark as a failure"
            git --no-pager diff
            exit 1
          fi
      - run:
          name: Save Images
          command: make BUILD_IN_CONTAINER=false save-images
      - save_cache:
          key: v1-service-{{ .Branch }}-{{ .Revision }}
          paths:
          - images/

  test:
    <<: *defaults
    steps:
      - checkout
      - run: echo -e "export GOPATH=$HOME\nexport PATH=/usr/local/go/bin:$HOME/bin:$PATH" >> $BASH_ENV
      # Link the working directory so that it appears in GOPATH. This is required for cover to map coverage statistics to sources.
      - run: mkdir -p ${GOPATH}/src/github.com/weaveworks && ln -s $(pwd) ${GOPATH}/src/github.com/weaveworks/service
      - run: go get github.com/mattn/goveralls
      - run: COVERDIR=./coverage make RM= test
      - run: ./tools/cover/gather_coverage.sh ./coverage $CIRCLE_WORKING_DIRECTORY/coverage
      - run: goveralls -repotoken $COVERALLS_REPO_TOKEN -coverprofile=$CIRCLE_WORKING_DIRECTORY/profile.cov -service=circleci || true
      - run: mkdir /tmp/coverage && cp coverage.* /tmp/coverage
      - store_artifacts:
          path: /tmp/coverage

  integration-test:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          key: v1-service-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Load Images
          command: make BUILD_IN_CONTAINER=false load-images
      # FIXME: we probably don't need to copy the code and change the working dir
      - run: echo -e "export GOPATH=$HOME\nexport SRCDIR=$HOME/src/github.com/weaveworks/service\nexport PATH=/usr/local/go/bin:$HOME/bin:$PATH" >> $BASH_ENV
      - run: mkdir -p $(dirname $SRCDIR) && cp -r $(pwd)/ $SRCDIR
      - run: go get github.com/nats-io/gnatsd
      - run:
          command: gnatsd
          background: true
      - run: |
          cd $SRCDIR
          make RM= notebooks-integration-test
          make RM= users-integration-test
          make RM= billing-integration-test
          make RM= pubsub-integration-test
          make RM= flux-integration-test
          make RM= kubectl-service-integration-test
          make RM= gcp-service-integration-test
          make RM= notification-integration-test

  upload:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          key: v1-service-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Load Images
          command: make BUILD_IN_CONTAINER=false load-images
      - run:
          name: Publish docker images to final repository
          command: |
            set -o pipefail
            export LAST_BUILD_COMMIT=$(curl -sS 'https://circleci.com/api/v1/project/weaveworks/service/tree/'$CIRCLE_BRANCH'?circle-token='$CIRCLE_TOKEN'&filter=successful&limit=50' | jq -r 'map(select(.build_parameters.CIRCLE_JOB == "upload")) | .[0].vcs_revision')
            echo Last successful build was commit $LAST_BUILD_COMMIT
            docker login -u "$DOCKER_REGISTRY_USER" -p "$DOCKER_REGISTRY_PASSWORD" quay.io
            ./push-images --if-changed-since $LAST_BUILD_COMMIT

  dry-run-upload:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          key: v1-service-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Load Images
          command: make BUILD_IN_CONTAINER=false load-images
      - run:
          name: Dry-run of publishing docker images
          command: |
            set -o pipefail
            export LAST_BUILD_COMMIT=$(curl -sS 'https://circleci.com/api/v1/project/weaveworks/service/tree/master?circle-token='$CIRCLE_TOKEN'&filter=successful&limit=50' | jq -r 'map(select(.build_parameters.CIRCLE_JOB == "upload")) | .[0].vcs_revision')
            echo Last successful build was commit $LAST_BUILD_COMMIT
            docker login -u "$DOCKER_REGISTRY_USER" -p "$DOCKER_REGISTRY_PASSWORD" quay.io
            ./push-images --dry-run --if-changed-since $LAST_BUILD_COMMIT

workflows:
  version: 2
  build_test_and_upload:
    jobs:
      - lint
      - test
      - build
      - integration-test:
          requires:
            - build
            - lint
            - test
      - upload:
          requires:
            - integration-test
          filters:
            branches:
              only: master
      - dry-run-upload:
          requires:
            - integration-test
          filters:
            branches:
              ignore: master
