#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

if [ $# -ne 2 ]
then
	echo "usage: $(basename $0) up/down <name>"
	exit 1
fi

WHAT=$1
NAME=$2

function create_tf_file {
	cp r53.template ${NAME}/r53.tf
}

function delete_tf_file {
	rm -f ${NAME}/r53.tf
}

function interactive_confirmation {
	while true
	do
		read -p "$1 " yn
		case $yn in
			yes) break;;
			no) exit;;
			*) echo "Please type 'yes' or 'no'";;
		esac
	done
}

function terraform_apply {
	(
		cd ${NAME}
		local tempfile=$(mktemp)
		trap "rm -rf ${tempfile}" EXIT
		terraform plan -state=tfstate -var-file=tfvars -out=${tempfile} -target=aws_route53_zone.zone -target=aws_route53_record.www
		interactive_confirmation "Do you wish to proceed with the plan?"
		terraform apply -state=tfstate ${tempfile}
	)
}

case $WHAT in
up)
	create_tf_file
	terraform_apply
	;;
down)
	delete_tf_file
	terraform_apply
	;;
*)
	echo "Unknown command"
	exit 1
	;;
esac
